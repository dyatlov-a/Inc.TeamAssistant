@page "/survey-summary/{RoomId:guid}"
@page "/ru/survey-summary/{RoomId:guid}"
@page "/en/survey-summary/{RoomId:guid}"

@attribute [Authorize]

@inject ISurveyService SurveyService
@inject TenantStore TenantStore
@inject RequestProcessor RequestProcessor

<MetaDataModule />

<SurveySummary
    RoomId="RoomId"
    Answers="_answers"
    AnswerByQuestions="_answerByQuestions"
    TotalAnswers="_totalAnswers"
    State="_state"
    Retry="Load" />

@code {
    [Parameter, EditorRequired]
    public Guid RoomId { get; set; }

    private const int SurveyTotal = 5;
    
    private readonly LoadingState _state = LoadingState.Done();
    private IReadOnlyCollection<PersonAnswerDto> _answers = [];
    private IReadOnlyCollection<SurveyQuestionDto> _answerByQuestions = [];
    private int _totalAnswers;

    protected override async Task OnParametersSetAsync() => await Load();

    private async Task Load()
    {
        await TenantStore.Initialize(RoomId, _state);
        
        var result = await RequestProcessor.Process(
            async () => await SurveyService.GetSurveySummary(RoomId, SurveyTotal),
            nameof(SurveySummaryContainer),
            _state);

        _answers = result.Answers;
        _answerByQuestions = result.AnswerByQuestions;
        _totalAnswers = result.TotalAnswers;
    }
}