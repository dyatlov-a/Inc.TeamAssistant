@page "/survey/{RoomId:guid}"
@page "/ru/survey/{RoomId:guid}"

@attribute [Authorize]

@inject TenantStore TenantStore
@inject ITenantService TenantService
@inject ISurveyService SurveyService
@inject RequestProcessor RequestProcessor
@inject IStringLocalizer<SurveyResources> Localizer

<MetaDataModule />

<AuthorizeView>
    <Authorized>
        <Survey
            RoomId="RoomId"
            CurrentUserId="context.User.ToPerson().Id"
            FacilitatorId="_facilitatorId"
            HasNext="@(_inProgress is not null)"
            MoveNext="MoveNext"
            FacilitatorGiven="FacilitatorGiven"
            RoomPropertiesOpened="OnRoomPropertiesOpened"
            State="_state"
            Retry="@(() => Load())" />
    </Authorized>
</AuthorizeView>
<ContentDialog Title="@Localizer["RoomProperties"]" @ref="_roomPropertiesEditor">
    <RoomPropertiesEditorContainer RoomId="RoomId" RoomPropertiesChanged="OnRoomPropertiesChanged" />
</ContentDialog>

@code {
    [Parameter, EditorRequired]
    public Guid RoomId { get; set; }

    private bool? _inProgress;
    private long? _facilitatorId;
    private ContentDialog? _roomPropertiesEditor;
    
    private readonly LoadingState _state = LoadingState.Done();
    
    protected override async Task OnParametersSetAsync() => await Load();

    private async Task Load(bool hardReset = true)
    {
        if (hardReset)
            await TenantStore.Initialize(RoomId, _state);
        
        var result = await RequestProcessor.Process(
            async () => await SurveyService.GetSurveyState(RoomId),
            nameof(SurveyContainer),
            _state);

        _inProgress = result.InProgress;
        _facilitatorId = result.FacilitatorId;
    }
    
    private async Task MoveNext()
    {
        if (!_inProgress.HasValue)
            return;

        if (_inProgress.Value)
            await RequestProcessor.Process(
                () => SurveyService.Finish(new FinishSurveyCommand(RoomId)),
                _state);
        else
            await RequestProcessor.Process(
                () => SurveyService.Start(new StartSurveyCommand(RoomId)),
                _state);
    }

    private async Task FacilitatorGiven()
    {
        // TODO: send event to hub
        await RequestProcessor.Process(
            async () => await TenantService.ChangeRoomProperties(ChangeRoomPropertiesCommand.ChangeFacilitator(RoomId)),
            _state);

        await Load(hardReset: false);
    }

    private void OnRoomPropertiesOpened() => _roomPropertiesEditor?.Open();
    private void OnRoomPropertiesChanged() => _roomPropertiesEditor?.Close();
}